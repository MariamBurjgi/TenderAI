import streamlit as st
import pdfplumber
from docx import Document
import io
from openai import OpenAI


API_KEY = st.secrets["OPENAI_API_KEY"]
# рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ: Word-рЃўрЃА рЃерЃћрЃЦрЃЏрЃюрЃљ
def create_word_docx(text_content):
    doc = Document()
    doc.add_heading('AI рЃАрЃљрЃбрЃћрЃюрЃЊрЃћрЃарЃЮ рЃљрЃюрЃљрЃџрЃўрЃќрЃў', 0)
    doc.add_paragraph(text_content)
    bio = io.BytesIO()
    doc.save(bio)
    return bio

# рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ: AI-рЃАрЃЌрЃЋрЃўрЃА рЃЎрЃўрЃЌрЃ«рЃЋрЃўрЃА рЃЊрЃљрЃАрЃЏрЃљ (рЃћрЃА рЃљрЃарЃўрЃА рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃбрЃЋрЃўрЃюрЃў!)
def ask_ai(full_text):
    if not API_KEY:
        return "Рџа№ИЈ рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ: API Key рЃљрЃа рЃљрЃарЃўрЃА рЃЏрЃўрЃЌрЃўрЃЌрЃћрЃЉрЃБрЃџрЃў рЃЎрЃЮрЃЊрЃерЃў!"
    
    client = OpenAI(api_key=API_KEY)
    
    # рЃљрЃЦ рЃЋрЃБрЃ«рЃАрЃюрЃў AI-рЃА, рЃЋрЃўрЃю рЃљрЃарЃўрЃА рЃўрЃА (Prompt Engineering)
    system_prompt = """
    рЃерЃћрЃю рЃ«рЃљрЃа рЃњрЃљрЃЏрЃЮрЃфрЃЊрЃўрЃџрЃў рЃўрЃБрЃарЃўрЃАрЃбрЃў рЃЊрЃљ рЃбрЃћрЃюрЃЊрЃћрЃарЃћрЃЉрЃўрЃА рЃАрЃърЃћрЃфрЃўрЃљрЃџрЃўрЃАрЃбрЃў рЃАрЃљрЃЦрЃљрЃарЃЌрЃЋрЃћрЃџрЃЮрЃерЃў.
    рЃерЃћрЃюрЃў рЃЏрЃўрЃќрЃљрЃюрЃўрЃљ рЃњрЃљрЃљрЃљрЃюрЃљрЃџрЃўрЃќрЃЮ рЃљрЃбрЃЋрЃўрЃарЃЌрЃБрЃџрЃў рЃбрЃћрЃЦрЃюрЃўрЃЎрЃБрЃарЃў рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃЊрЃљ рЃЏрЃЮрЃљрЃЏрЃќрЃљрЃЊрЃЮ рЃЏрЃЮрЃЎрЃџрЃћ рЃарЃћрЃќрЃўрЃБрЃЏрЃћ.
    рЃњрЃљрЃЏрЃЮрЃДрЃљрЃЋрЃў:
    1. рЃерЃћрЃЏрЃАрЃДрЃўрЃЊрЃЋрЃћрЃџрЃў рЃЊрЃљ рЃерЃћрЃАрЃДрЃўрЃЊрЃЋрЃўрЃА рЃАрЃљрЃњрЃљрЃюрЃў.
    2. рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃАрЃљрЃЎрЃЋрЃљрЃџрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃЮ рЃЏрЃЮрЃЌрЃ«рЃЮрЃЋрЃюрЃћрЃЉрЃў.
    3. рЃАрЃљрЃГрЃўрЃарЃЮ рЃЊрЃЮрЃЎрЃБрЃЏрЃћрЃюрЃбрЃћрЃЉрЃўрЃА рЃАрЃўрЃљ.
    4. рЃАрЃљрЃЋрЃљрЃарЃљрЃБрЃЊрЃЮ рЃарЃўрЃАрЃЎрЃћрЃЉрЃў.
    """
    
    response = client.chat.completions.create(
        model="gpt-4o", # рЃљрЃю gpt-3.5-turbo (рЃБрЃцрЃарЃЮ рЃўрЃљрЃцрЃўрЃљ)
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": f"рЃљрЃў рЃбрЃћрЃюрЃЊрЃћрЃарЃўрЃА рЃбрЃћрЃЦрЃАрЃбрЃў:\n\n{full_text[:10000]}"} # рЃърЃўрЃарЃЋрЃћрЃџ 10,000 рЃАрЃўрЃЏрЃЉрЃЮрЃџрЃЮрЃА рЃЋрЃљрЃњрЃќрЃљрЃЋрЃюрЃўрЃЌ рЃџрЃўрЃЏрЃўрЃбрЃўрЃА рЃњрЃљрЃЏрЃЮ
        ]
    )
    return response.choices[0].message.content

# --- рЃАрЃљрЃўрЃбрЃўрЃА рЃЋрЃўрЃќрЃБрЃљрЃџрЃў ---
st.title("­Ъцќ Tender AI - рЃцрЃўрЃюрЃљрЃџрЃБрЃарЃў рЃЋрЃћрЃарЃАрЃўрЃљ")
st.write("рЃљрЃбрЃЋрЃўрЃарЃЌрЃћ PDF рЃЊрЃљ рЃЏрЃўрЃўрЃдрЃћ рЃарЃћрЃљрЃџрЃБрЃарЃў рЃљрЃюрЃљрЃџрЃўрЃќрЃў.")

uploaded_file = st.file_uploader("рЃљрЃўрЃарЃЕрЃўрЃћрЃЌ PDF рЃцрЃљрЃўрЃџрЃў", type="pdf")

if uploaded_file is not None:
    st.success("РюЁ рЃцрЃљрЃўрЃџрЃў рЃЏрЃўрЃдрЃћрЃЉрЃБрЃџрЃўрЃљ!")
    
    # PDF рЃЎрЃўрЃЌрЃ«рЃЋрЃљ
    with pdfplumber.open(uploaded_file) as pdf:
        full_text = ""
        for page in pdf.pages:
            text = page.extract_text()
            if text:
                full_text += text + "\n"
    
    with st.expander("рЃюрЃљрЃ«рЃћ PDF-рЃўрЃА рЃбрЃћрЃЦрЃАрЃбрЃў"):
        st.text(full_text)
    
    # рЃдрЃўрЃџрЃљрЃЎрЃў
    if st.button("рЃЊрЃљрЃљрЃњрЃћрЃюрЃћрЃарЃўрЃарЃћ рЃљрЃюрЃљрЃџрЃўрЃќрЃў (AI)"):
        if API_KEY == "":
            st.error("­ЪЏЉ рЃњрЃљрЃЕрЃћрЃарЃЊрЃў! рЃ»рЃћрЃа рЃЎрЃЮрЃЊрЃерЃў API Key рЃљрЃа рЃЕрЃљрЃњрЃўрЃгрЃћрЃарЃўрЃљ.")
            st.info("рЃњрЃљрЃўрЃ«рЃАрЃюрЃљрЃА main.py рЃЊрЃљ рЃЏрЃћ-9 рЃ«рЃљрЃќрЃќрЃћ рЃЕрЃљрЃўрЃгрЃћрЃарЃЮрЃА рЃЕрЃћрЃЏрЃў рЃњрЃљрЃАрЃљрЃдрЃћрЃЉрЃў.")
        else:
            with st.spinner("AI рЃЏрЃБрЃерЃљрЃЮрЃЉрЃА... (рЃљрЃЏрЃљрЃА рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ 10-20 рЃгрЃљрЃЏрЃў рЃЊрЃљрЃАрЃГрЃўрЃарЃЊрЃћрЃА)"):
                try:
                    # рЃљрЃЦ рЃЏрЃўрЃЋрЃЏрЃљрЃарЃЌрЃљрЃЋ OpenAI-рЃА
                    ai_response = ask_ai(full_text)
                    
                    st.markdown("### ­Ъцќ AI-рЃА рЃЊрЃљрЃАрЃЎрЃЋрЃюрЃљ:")
                    st.write(ai_response)
                    
                    # Word-рЃўрЃА рЃњрЃљрЃЊрЃЏрЃЮрЃгрЃћрЃарЃљ
                    docx_file = create_word_docx(ai_response)
                    st.download_button(
                        label="­ЪЊЦ рЃњрЃљрЃЊрЃЏрЃЮрЃгрЃћрЃарЃћ рЃЊрЃљрЃАрЃЎрЃЋрЃюрЃљ Word-рЃерЃў",
                        data=docx_file.getvalue(),
                        file_name="tender_analizi.docx",
                        mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                    )
                except Exception as e:
                    st.error(f"рЃЏрЃЮрЃ«рЃЊрЃљ рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ: {e}")